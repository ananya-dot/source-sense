<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase App</title>
    <link rel="icon" type="image/png" sizes="96x96" href="https://atlan.com/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://atlan.com/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://atlan.com/favicon-16x16.png">
    <link rel="stylesheet" href="{{ url_for('static', path='styles.css') }}">
</head>
<body>
    <script>
        // You can use this to set the environment variables for the frontend
        window.env = {
          APP_HTTP_HOST: "{{ app_http_host }}",
          APP_HTTP_PORT: "{{ app_http_port }}",
          APP_DASHBOARD_HTTP_HOST: "{{ app_dashboard_http_host }}",
          APP_DASHBOARD_HTTP_PORT: "{{ app_dashboard_http_port }}",
          TENANT_ID: "{{ tenant_id }}",
          APP_NAME: "{{ app_name }}",
          TEMPORAL_UI_HOST: "{{ workflow_ui_host }}",
          TEMPORAL_UI_PORT: "{{ workflow_ui_port }}",
        }
    </script>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo-container">
                <img src="https://cdn-icons-png.flaticon.com/512/5968/5968313.png" alt="Supabase Logo" class="logo" width="100" height="100">
                <h1>Supabase App</h1>
            </div>
            <div class="doc-link">
                <a href="https://supabase.com/docs" target="_blank" class="doc-link-button">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="24" height="24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" />
                    </svg>
                    <span>Documentation</span>
                </a>
            </div>
        </header>

        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="step-list">
                    <div class="step active" data-step="1" onclick="goToPage(1)">
                        <div class="step-indicator">1</div>
                        <span>Credential</span>
                    </div>
                    <div class="step" data-step="2" onclick="goToPage(2)">
                        <div class="step-indicator">2</div>
                        <span>Connection</span>
                    </div>
                    <div class="step" data-step="3" onclick="goToPage(3)">
                        <div class="step-indicator">3</div>
                        <span>Metadata</span>
                    </div>
                </div>
            </div>

            <!-- Form Container -->
            <div class="form-container">
                <!-- Page 1: Credentials -->
                <div id="page1" class="page active">
                    <div class="form-group horizontal">
                        <div class="input-wrapper flex-grow">
                            <label>Host *</label>
                            <input type="text" id="host" placeholder="db.[project-ref].supabase.co">
                        </div>
                        <div class="input-wrapper" style="width: 100px;">
                            <label>Port *</label>
                            <input type="text" id="port" value="5432">
                        </div>
                    </div>

                    <div class="section">
                        <h2>Authentication</h2>
                        <div class="button-group">
                            <button class="btn btn-primary">Basic</button>
                            <button class="btn btn-secondary">IAM User</button>
                            <button class="btn btn-secondary">IAM Role</button>
                        </div>
                    </div>

                    <div class="form-group horizontal">
                        <div class="input-wrapper flex-half">
                            <label>Username *</label>
                            <input type="text" id="user" value="postgres">
                        </div>
                        <div class="input-wrapper flex-half">
                            <label>Password *</label>
                            <input type="password" id="password" placeholder="Password">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Database *</label>
                        <input type="text" id="database" value="postgres">
                    </div>

                    <button class="btn btn-outline test-connection" onclick="testConnection()">Test Connection</button>
                    <div class="error-message" id="connectionError"></div>

                    <div class="bottom-bar">
                        <div id="page1-nav" class="nav-buttons">
                            <div></div> <!-- Empty div for spacing -->
                            <button onclick="nextPage()" class="btn btn-primary" id="nextButton">Next</button>
                        </div>
                    </div>
                </div>

                <!-- Page 2: Connection -->
                <div id="page2" class="page">
                    <div class="form-group">
                        <label>Connection Name *</label>
                        <input type="text" id="connectionName" placeholder="my-supabase-project">
                    </div>

                    <div class="bottom-bar">
                        <div id="page2-nav" class="nav-buttons" style="display: none;">
                            <button onclick="previousPage()" class="btn btn-secondary">Previous</button>
                            <button onclick="nextPage()" class="btn btn-primary" id="page2Next">Next</button>
                        </div>
                    </div>
                </div>

                <!-- Page 3: Metadata -->
                <div id="page3" class="page">
                    <div class="metadata-grid">
                        <div class="form-group">
                            <label>Exclude Metadata</label>
                            <div class="metadata-dropdown" id="excludeMetadata">
                                <div class="dropdown-header" onclick="toggleDropdown('excludeMetadata')">
                                    <span>Select databases and schemas</span>
                                    <span class="dropdown-arrow">▼</span>
                                </div>
                                <div class="dropdown-content">
                                    <!-- Will be populated dynamically -->
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Include Metadata</label>
                            <div class="metadata-dropdown" id="includeMetadata">
                                <div class="dropdown-header" onclick="toggleDropdown('includeMetadata')">
                                    <span>Select databases and schemas</span>
                                    <span class="dropdown-arrow">▼</span>
                                </div>
                                <div class="dropdown-content">
                                    <!-- Will be populated dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Exclude regex for tables & views</label>
                        <input type="text" id="temp-table-regex" placeholder=".*_TMP|.*_TEMP|TMP:*|TEMP:*" >
                    </div>


                    <div class="preflight-section">
                        <div class="preflight-header">
                            <h2>Preflight Checks</h2>
                            <button id="runPreflightChecks" class="btn btn-primary">Check</button>
                        </div>
                        <div class="preflight-content">
                            <!-- Results will be dynamically inserted here -->
                        </div>
                    </div>

                    <div class="bottom-bar">
                        <div id="page3-nav" class="nav-buttons" style="display: none;">
                            <button onclick="previousPage()" class="btn btn-secondary">Previous</button>
                            <div class="action-buttons">
                                <button id="runWorkflowButton" class="btn btn-primary" onclick="runWorkflow()">Run</button>
                                <button id="scheduleWorkflowButton" class="btn btn-secondary" onclick="scheduleAndRunWorkflow()">Schedule & Run</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Add this at the end of body but before scripts -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div class="success-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" />
                </svg>
            </div>
            <h2>Workflow Started Successfully!</h2>
            <p>Your Supabase metadata extraction workflow has been initiated and is now running.</p>
            <div class="modal-actions">
                <a href="http://{{ workflow_ui_host }}:{{ workflow_ui_port }}/namespaces/default/workflows" class="btn btn-primary" target="_blank">Go to Dashboard</a>
            </div>
        </div>
    </div>
    <script>
        // Embedded JavaScript for Supabase App
        let currentPage = 1;
        const formData = {};
        let currentAuthType = "basic";

        function updateFormData() {
            const inputs = document.querySelectorAll('input[type="text"], input[type="password"]');
            inputs.forEach(input => {
                if (input.value) {
                    formData[input.id] = input.value;
                }
            });
        }

        function updateSteps() {
            const steps = document.querySelectorAll('.step');
            steps.forEach((step, index) => {
                const stepNumber = index + 1;
                step.classList.remove('active', 'completed');
                if (stepNumber === currentPage) {
                    step.classList.add('active');
                } else if (stepNumber < currentPage) {
                    step.classList.add('completed');
                }
            });
        }

        function goToPage(pageNumber) {
            // Validate page number
            if (pageNumber < 1 || pageNumber > 3) return;

            // Prevent unauthorized navigation
            if (pageNumber > currentPage) {
                // Check if trying to go past page 1 without authentication
                if (pageNumber > 1 && !sessionStorage.getItem('authenticationComplete')) {
                    return;
                }

                // Check if trying to go past page 2
                if (pageNumber > 2) {
                    const connectionName = document.getElementById('connectionName').value.trim();
                    if (!connectionName) {
                        return;
                    }
                }
            }

            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // Hide all navigation buttons
            document.querySelectorAll('.nav-buttons').forEach(nav => {
                nav.style.display = 'none';
            });

            // Show selected page
            document.getElementById(`page${pageNumber}`).classList.add('active');

            // Show corresponding navigation buttons
            document.getElementById(`page${pageNumber}-nav`).style.display = 'flex';

            // If navigating to page 3, populate metadata dropdowns
            if (pageNumber === 3) {
                populateMetadataDropdowns();
            }

            // Update current page and steps
            currentPage = pageNumber;
            updateSteps();
        }

        async function nextPage() {
            // If on page 1, ensure authentication is complete
            if (currentPage === 1) {
                if (!sessionStorage.getItem('authenticationComplete')) {
                    const success = await testConnection();
                    if (!success) {
                        return;
                    }
                }
                goToPage(2);
                return;
            }

            // For page 2
            if (currentPage === 2) {
                const connectionNameInput = document.getElementById('connectionName');
                const connectionName = connectionNameInput.value.trim();

                if (!connectionName) {
                    connectionNameInput.style.border = '2px solid #DC2626';
                    connectionNameInput.style.animation = 'shake 0.5s';
                    connectionNameInput.addEventListener('animationend', () => {
                        connectionNameInput.style.animation = '';
                    });
                    connectionNameInput.addEventListener('input', () => {
                        connectionNameInput.style.border = '1px solid var(--border-color)';
                    }, { once: true });
                    return;
                }

                goToPage(3);
                return;
            }
        }

        function previousPage() {
            if (currentPage > 1) {
                goToPage(currentPage - 1);
            }
        }

        async function testConnection() {
            console.log('testConnection function called');
            const testButton = document.querySelector('.test-connection');
            const errorElement = document.getElementById('connectionError');
            const nextButton = document.getElementById('nextButton');

            try {
                console.log('Starting connection test...');
                // Disable test button and show loading state
                testButton.disabled = true;
                testButton.textContent = 'Testing...';
                errorElement.classList.remove('visible');

                const success = await performConnectionTest();
                console.log('Connection test result:', success);

                if (success) {
                    // Success case
                    testButton.innerHTML = `Connection Successful <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20" style="margin-left: 8px">
                        <path fill-rule="evenodd" d="M8.603 3.799A4.49 4.49 0 0112 2.25c1.357 0 2.573.6 3.397 1.549a4.49 4.49 0 013.498 1.307 4.491 4.491 0 011.307 3.497A4.49 4.49 0 0121.75 12a4.49 4.49 0 01-1.549 3.397 4.491 4.491 0 01-1.307 3.497 4.491 4.491 0 01-3.497 1.307A4.49 4.49 0 0112 21.75a4.49 4.49 0 01-3.397-1.549 4.49 4.49 0 01-3.498-1.306 4.491 4.491 0 01-1.307-3.498A4.49 4.49 0 012.25 12c0-1.357.6-2.573 1.549-3.397a4.49 4.49 0 011.307-3.497 4.49 4.49 0 013.497-1.307zm7.007 6.387a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" />
                    </svg>`;
                    testButton.disabled = true;
                    testButton.style.backgroundColor = '#10B981';
                    testButton.style.borderColor = '#10B981';
                    testButton.style.color = 'white';

                    // Enable next button
                    nextButton.disabled = false;
                    nextButton.style.opacity = '1';

                    // Mark authentication as complete
                    sessionStorage.setItem('authenticationComplete', 'true');

                    return true;
                } else {
                    throw new Error('Connection test failed');
                }
            } catch (error) {
                console.error('Connection test error:', error);
                // Error case
                testButton.textContent = 'Test Connection';
                testButton.disabled = false;
                errorElement.textContent = 'Connection failed. Please check your credentials and try again.';
                errorElement.classList.add('visible');
                return false;
            }
        }

        async function performConnectionTest() {
            console.log('performConnectionTest called');
            const payload = {
                host: document.getElementById('host').value,
                port: parseInt(document.getElementById('port').value),
                user: document.getElementById('user').value,
                password: document.getElementById('password').value,
                database: document.getElementById('database').value
            };
            console.log('Payload:', payload);

            try {
                const response = await fetch('/workflows/v1/auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                return response.ok;
            } catch (error) {
                console.error('Request failed:', error);
                return false;
            }
        }

        function toggleDropdown(id) {
            const dropdown = document.getElementById(id);
            const content = dropdown.querySelector('.dropdown-content');
            const arrow = dropdown.querySelector('.dropdown-arrow');
            
            if (content.style.display === 'block') {
                content.style.display = 'none';
                arrow.textContent = '▼';
            } else {
                content.style.display = 'block';
                arrow.textContent = '▲';
            }
        }

        function populateMetadataDropdowns() {
            // This would normally fetch from the backend
            // For now, we'll add some sample data
            const excludeDropdown = document.getElementById('excludeMetadata').querySelector('.dropdown-content');
            const includeDropdown = document.getElementById('includeMetadata').querySelector('.dropdown-content');
            
            // Sample metadata options
            const metadataOptions = [
                { type: 'database', name: 'postgres', schemas: ['public', 'auth', 'storage'] },
            ];
            
            metadataOptions.forEach(db => {
                const dbItem = document.createElement('div');
                dbItem.className = 'dropdown-item';
                dbItem.innerHTML = `
                    <input type="checkbox" id="exclude-${db.name}" value="${db.name}">
                    <label for="exclude-${db.name}">${db.name}</label>
                `;
                excludeDropdown.appendChild(dbItem);
                
                const includeItem = document.createElement('div');
                includeItem.className = 'dropdown-item';
                includeItem.innerHTML = `
                    <input type="checkbox" id="include-${db.name}" value="${db.name}" checked>
                    <label for="include-${db.name}">${db.name}</label>
                `;
                includeDropdown.appendChild(includeItem);
            });
        }

        async function runWorkflow() {
            const runButton = document.getElementById('runWorkflowButton');
            const scheduleButton = document.getElementById('scheduleWorkflowButton');
            
            try {
                // Disable buttons and show loading state
                runButton.disabled = true;
                scheduleButton.disabled = true;
                runButton.textContent = 'Starting...';
                
                // Collect form data in the correct format
                const workflowData = {
                    credentials: {
                        authType: "basic",
                        host: document.getElementById('host').value,
                        port: parseInt(document.getElementById('port').value),
                        username: document.getElementById('user').value,
                        password: document.getElementById('password').value,
                        database: document.getElementById('database').value
                    },
                    connection: {
                        connection: document.getElementById('connectionName').value
                    },
                    metadata: {
                        "include-filter": '{"^postgres$":["^public$","^auth$","^storage$"]}',
                        "exclude-filter": "{}",
                        "temp-table-regex": document.getElementById('temp-table-regex').value || '.*_TMP|.*_TEMP|TMP:*|TEMP:*'
                    }
                };

                console.log('Starting workflow with data:', workflowData);

                // Start the workflow
                const response = await fetch('/workflows/v1/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(workflowData)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Workflow started successfully:', result);
                    
                    // Show success modal
                    showSuccessModal();
                } else {
                    const error = await response.json();
                    console.error('Failed to start workflow:', error);
                    alert('Failed to start workflow: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error starting workflow:', error);
                alert('Error starting workflow: ' + error.message);
            } finally {
                // Re-enable buttons
                runButton.disabled = false;
                scheduleButton.disabled = false;
                runButton.textContent = 'Run';
            }
        }

        async function scheduleAndRunWorkflow() {
            const runButton = document.getElementById('runWorkflowButton');
            const scheduleButton = document.getElementById('scheduleWorkflowButton');
            
            try {
                // Disable buttons and show loading state
                runButton.disabled = true;
                scheduleButton.disabled = true;
                scheduleButton.textContent = 'Scheduling...';
                
                // Collect form data in the correct format
                const workflowData = {
                    credentials: {
                        authType: "basic",
                        host: document.getElementById('host').value,
                        port: parseInt(document.getElementById('port').value),
                        username: document.getElementById('user').value,
                        password: document.getElementById('password').value,
                        database: document.getElementById('database').value
                    },
                    connection: {
                        connection: document.getElementById('connectionName').value
                    },
                    metadata: {
                        "include-filter": '{"^postgres$":["^public$","^auth$","^storage$"]}',
                        "exclude-filter": "{}",
                        "temp-table-regex": document.getElementById('temp-table-regex').value || '.*_TMP|.*_TEMP|TMP:*|TEMP:*'
                    },
                    schedule: true,
                    scheduleTime: new Date().toISOString() // Schedule for immediate execution
                };

                console.log('Scheduling workflow with data:', workflowData);

                // Start the scheduled workflow
                const response = await fetch('/workflows/v1/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(workflowData)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Workflow scheduled successfully:', result);
                    
                    // Show success modal with schedule info
                    showSuccessModal('Your Supabase metadata extraction workflow has been scheduled and will start shortly.');
                } else {
                    const error = await response.json();
                    console.error('Failed to schedule workflow:', error);
                    alert('Failed to schedule workflow: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error scheduling workflow:', error);
                alert('Error scheduling workflow: ' + error.message);
            } finally {
                // Re-enable buttons
                runButton.disabled = false;
                scheduleButton.disabled = false;
                scheduleButton.textContent = 'Schedule & Run';
            }
        }

        function showSuccessModal(customMessage = null) {
            const modal = document.getElementById('successModal');
            const messageElement = modal.querySelector('p');
            
            if (customMessage) {
                messageElement.textContent = customMessage;
            }
            
            modal.style.display = 'flex';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                modal.style.display = 'none';
            }, 5000);
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            updateSteps();
            updateFormData();
        });
    </script>
</body>
</html>
